"use strict";$(function(){function k(o){return void 0===o&&(o=1024),window.innerWidth<=o}var o={zoom:6.5,center:[-116.0987,44.7]},t={font:["Open Sans Bold","Arial Unicode MS Bold"],minZoom:6,maxZoom:18},e=$("#photo-count"),i=$("#photo-preview"),n=$("nav .zoom-out"),a=$("#legend .toggle"),l=post?"/"+post.key:"",r=function(){for(var o=window.location.search.split(/[&\?]/g),t={},e=0;e<o.length;e++){var n=o[e].split("=");2==n.length&&(t[n[0]]=parseFloat(n[1]))}void 0!==t.lon&&void 0!==t.lat&&(t.center=[t.lon,t.lat]);return t}(),c=new mapboxgl.NavigationControl,b=new mapboxgl.Map({container:"map-canvas",style:"mapbox://styles/"+mapStyle,center:r.center||o.center,zoom:r.zoom||o.zoom,maxZoom:18,dragRotate:!1,keyboard:!1}),s=b.getCanvasContainer(),d={width:0,height:0},u=322,p=350,g=!1,m=!k(),h=!0,f=!1,x=null,C={coordinate:function(o){function t(o){return Math.round(o*e)/e}var e=Math.pow(10,5);return t(o[1])+", "+t(o[0])},photo:function(o){var n=o.properties;if(void 0===n.url)return null;var t="Click or tap to enlarge";return $("<figure>").append($("<img>").attr("src",n.url).attr("title",t).attr("alt",t).click(function(){var o,t,e;o=n.url,t=o.split("/"),e=t[t.length-1].split("_"),window.location.href="/"+e[0]})).append($("<figcaption>").html(this.coordinate(o.geometry.coordinates)))},photoPreview:function(o,t,e,n){i.empty().removeClass().css(function(o){var t=o.point.x,e=o.point.y;{if(k(767))return{top:(d.height-p)/2,right:0};var n={x:t+u-d.width,y:e+p-d.height};return n.x=n.x<0?0:n.x+10,n.y=n.y<0?0:n.y+10,t-=n.x,e-=n.y,0<n.x+n.y&&b.panBy([n.x,n.y],{duration:100},{lngLat:o.lngLat,type:"",point:o.point,originalEvent:o.originalEvent,reason:"fit",target:o.target}),{top:e+15,left:t+50}}}(o)),void 0!==n&&i.append(n),i.addClass(t).append(e).append(util.html.icon("close",v.closePreview)).show({complete:v.previewShown})}},v={zoomEnd:function(){w(),y()},keyNav:null,mapInteraction:function(o){void 0!==o&&"fit"!=o.reason&&v.closePreview()},windowResize:function(){var o=$("canvas");d.width=o.width(),d.height=o.height()},copyUrl:function(o){var t=$("<textarea>").text(window.location.href).appendTo(document.body).hide(),e=document.createRange();try{e.selectNode(t[0]);var n=window.getSelection();null!==n&&(n.removeAllRanges(),n.addRange(e))}catch(o){console.error(o)}t.remove()},buttonClick:function(o){window.location.href=$(this).data("link")},mapLink:function(o){var t=b.getCenter(),e=b.getZoom(),n=1/Math.pow(2.3,e)*375e6;window.location.href=$(this).data("link").replace("{lat}",t.lat).replace("{lon}",t.lng).replace("{zoom}",e).replace("{altitude}",n)},photoClick:function(o){var t=C.photo(o.features[0]);null!==t&&C.photoPreview(o,"single",t)},previewShown:function(){b.on("move",v.mapInteraction)},closePreview:function(){i.hide(),z(!1),b.off("move",v.mapInteraction)},photoLayerToggle:function(o){var t=(h=!h)?"visible":"none";["cluster","cluster-count","photo"].forEach(function(o){b.setLayoutProperty(o,"visibility",t)}),$(this).find("p").html((h?"Hide":"Show")+" Photos")},legendToggle:function(){a.parents("ul").toggleClass("collapsed"),$("nav .toggle-legend").toggleClass("active"),m=!m,k()||(util.setting.showMapLegend=m)},clusterClick:function(o){function t(){b.easeTo({center:o.lngLat,zoom:18-d<2?18:d+2})}var r,e,n,i,a,l,c,s=o.features[0].properties,d=b.getZoom();if(void 0!==s.point_count&&20<s.point_count&&d<16)t();else{var u=void 0===s.point_count?[]:(r=o.lngLat,e=s.point_count,n=b.getZoom(),i=3*n/Math.pow(2,n),a=[r.lng-i,r.lat-i],l=[r.lng+i,r.lat+i],(c=null===x?[]:x.features.filter(function(o){var t=o.geometry.coordinates;return t[0]>=a[0]&&t[1]>=a[1]&&t[0]<=l[0]&&t[1]<=l[1]}).map(function(o){var t,e,n,i,a,l;return o.properties.distance=(t=r,e=o.geometry.coordinates,n=t.lng,i=t.lat,a=e[0],l=e[1],Math.sqrt(Math.pow(a-n,2)+Math.pow(l-i,2))),o})).sort(function(o,t){var e=o.properties.distance,n=t.properties.distance;return void 0===e&&(e=0),void 0===n&&(n=0),e-n}),c.slice(0,e));if(0==u.length)t();else{var p=1,g=$("<div>").addClass("photo-list"),m=$("<div>").addClass("markers"),h=function(o){(p+=o)>u.length?p=1:p<1&&(p=u.length),$("figure",g).hide(),$("i",m).removeClass("selected"),$("figure:nth-child("+p+")",g).show(),$("i:nth-child("+p+")",m).addClass("selected"),0},f=function(){h(-1)},v=function(){h(1)};k()||z(!0,v,f);for(var w=0;w<u.length;w++){var y=C.photo(u[w]);null!==y&&g.append(y)}if(20<u.length){m.addClass("too-many");for(w=0;w<u.length;w++)m.append($("<i>").html((w+1).toString()));m.append("of "+u.length)}else for(w=0;w<u.length;w++)m.append(util.html.icon("place"));$("i:first-child",m).addClass("selected"),C.photoPreview(o,"list",g,$("<nav>").append(util.html.icon("arrow_back",f)).append(m).append($("<div>").addClass("mobile-tip").html("tap photo to view post")).append(util.html.icon("arrow_forward",v)))}}}};function z(o,t,e){o?(v.keyNav=function(o){switch(o.keyCode){case 27:v.mapInteraction();break;case 37:void 0!==e&&e();break;case 39:void 0!==t&&t()}},document.addEventListener("keydown",v.keyNav)):null!==v.keyNav&&document.removeEventListener("keydown",v.keyNav)}function w(){if(f){var o=b.getCenter(),t=l+"/map?lat="+o.lat+"&lon="+o.lng+"&zoom="+b.getZoom();window.history.replaceState(null,"",t)}}function y(){void 0!==o.zoom&&(b.getZoom()>o.zoom&&!g?(g=!0,n.click(function(){b.easeTo(o)}).removeClass("disabled")):b.getZoom()<=o.zoom&&g&&(g=!1,n.off("click").addClass("disabled")))}r.center&&y(),a.click(v.legendToggle),$("nav button.toggle-legend").click(v.legendToggle),$("nav button.map-link").click(v.mapLink),$("nav button.copy-url").click(v.copyUrl),$("nav button.toggle-photos").click(v.photoLayerToggle),window.addEventListener("resize",v.windowResize),m?util.setting.showMapLegend||a.click():a.parents("ul").addClass("collapsed"),b.addControl(c,"top-right").on("load",function(){$.getJSON("/geo.json",function(o){null!==(x=o)?(e.find("div").html(x.features.length.toString()),function(){null!==x&&b.addSource("photos",{type:"geojson",data:x,cluster:!0,clusterMaxZoom:18,clusterRadius:30});b.addLayer({id:"cluster",type:"circle",source:"photos",filter:["has","point_count"],paint:{"circle-color":"#422","circle-radius":{property:"point_count",type:"interval",stops:[[0,10],[10,12],[100,15]]},"circle-opacity":.6,"circle-stroke-width":3,"circle-stroke-color":"#ccc"}}),b.addLayer({id:"cluster-count",type:"symbol",source:"photos",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":t.font,"text-size":14},paint:{"text-color":"#fff"}}),b.addLayer({id:"photo",type:"circle",source:"photos",filter:["!has","point_count"],paint:{"circle-color":"#f00","circle-radius":7,"circle-stroke-width":4,"circle-stroke-color":"#fdd","circle-opacity":.6}})}(),b.on("mouseenter","cluster",L("pointer")).on("mouseleave","cluster",L()).on("mouseenter","photo",L("pointer")).on("mouseleave","photo",L()).on("zoomend",v.zoomEnd).on("moveend",w).on("click","cluster",v.clusterClick).on("click","photo",v.photoClick),b.addSource("moscow-mountain",{type:"vector",url:"mapbox://jabbott7.1q8zrllv"}),b.addLayer({id:"mountain-labels",type:"symbol",source:"moscow-mountain","source-layer":"moscow-mountain-dvde24",layout:{"text-font":t.font,"text-field":"{name}","text-size":{base:1,stops:[[10,10],[14,13]]},"text-rotation-alignment":"map","symbol-spacing":50},paint:{"text-color":"#fff","text-halo-color":"#000","text-halo-width":1,"text-halo-blur":1},minzoom:6,maxzoom:18}),b.addLayer({id:"mountain-tracks",type:"line",source:"moscow-mountain","source-layer":"moscow-mountain-dvde24",paint:{"line-color":"#55f","line-width":{base:1,stops:[[8,1],[13,2]]}},minzoom:t.minZoom,maxzoom:t.maxZoom},"mountain-labels"),v.windowResize(),post?(post.bounds.sw[0]-=.01,post.bounds.sw[1]-=.01,post.bounds.ne[0]+=.01,post.bounds.ne[1]+=.01,$.getJSON("/"+post.key+"/geo.json",S)):f=!0):console.error("Unable to retrieve blog GeoJSON")})});var L=function(o){return void 0===o&&(o=""),function(){s.style.cursor=o}};function S(o){0<o.features.length&&(b.addSource("track",{type:"geojson",data:o}).addLayer({id:"track",type:"line",source:"track",layout:{"line-join":"round","line-cap":"butt"},paint:{"line-color":"#f22","line-width":5,"line-opacity":.7,"line-dasharray":[1,.8]}},"photo"),$("#legend .track").removeClass("hidden")),$("nav > button.link").click(v.buttonClick),b.once("zoomend",function(){window.setTimeout(function(){f=!0},500)}),b.fitBounds([post.bounds.sw,post.bounds.ne])}});var util={setting:{save:function(o,t){window.localStorage&&localStorage.setItem(o,t)},load:function(o){return window.localStorage?localStorage.getItem(o):null},set showMapLegend(o){util.setting.save("map-legend",o?"true":"false")},get showMapLegend(){var o=util.setting.load("map-legend");return!o||"true"==o},set menuCategory(o){"string"==typeof o&&(o=[o,null]),null!==o&&util.setting.save("menu",o.join())},get menuCategory(){var o=util.setting.load("menu");return null===o?null:o[1].split(",")}},html:{icon:function(o,t){var e=$("<i>").addClass("material-icons "+o).text(o);return void 0!==t&&e.click(t),e}}};
//# sourceMappingURL=/js/maps/mapbox.js.map
